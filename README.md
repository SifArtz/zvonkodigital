# zvonkodigital

Этот репозиторий содержит инструменты для работы с API `zvonkodigital`, включая:
- PKCE OAuth-скрипт с кешированием и обновлением токенов;
- Telegram-бота на `aiogram 2.5`, который ищет релизы по UPC и проверяет наличие треков в плейлистах на нескольких площадках;
- Веб-интерфейс на FastAPI с HTML/CSS/JS для добавления UPC и просмотра попаданий по неделям.

## Требования
- Python 3.11+
- Установленные пакеты: `requests`, `beautifulsoup4`, `aiohttp`, `aiogram==2.5`, `fastapi`, `uvicorn`

Установите зависимости:

```bash
pip install requests beautifulsoup4 aiohttp aiogram==2.5 fastapi uvicorn
```

## PKCE-скрипт (одноразовый запуск)
Запустите скрипт, передав логин и пароль:

```bash
python zvonkodigital_auth.py --username YOUR_LOGIN --password YOUR_PASSWORD
```

Скрипт:
1. Генерирует `code_verifier` и `code_challenge` для PKCE.
2. Загружает страницу логина, извлекает CSRF-токен и отправляет форму.
3. Извлекает `authorization_code` из редиректа.
4. Обменивает код на `access_token` и `refresh_token`, выводя ответ в формате JSON и записывая кеш (по умолчанию `token_cache.json`).

При неверных учётных данных скрипт вернёт сообщение об ошибке в stderr и завершится с кодом 1.

## Telegram-бот
Бот ищет релиз по UPC и проверяет наличие треков в плейлистах на площадках ВК, Яндекс Музыка, МТС Музыка и Звук. Проверка делается на дату старта продаж + 7 дней (без выхода в будущее); если релиз ещё не вышел или неделю после релиза плейлистов нет, UPC сохраняется в локальной SQLite базе и перепроверяется раз в неделю (до двух раз).

Переменные окружения:
- `BOT_TOKEN` — токен бота (обязательно)
- `ACCOUNT_USERNAME` и `ACCOUNT_PASSWORD` — учётные данные для OAuth (обязательно)
- `TOKEN_CACHE` — путь для сохранения токенов (опционально, по умолчанию `token_cache.json`)
- `UPC_DB` — путь до SQLite-базы для очереди UPC (опционально, по умолчанию `upc_checks.db` в текущей директории)

Запуск:

```bash
export BOT_TOKEN=...
export ACCOUNT_USERNAME=...
export ACCOUNT_PASSWORD=...
python bot.py
```

Отправьте боту один или несколько UPC кодов через пробел или новую строку. В ответе вы получите группировку по неделям (неделя, в которую попадает дата старта продаж релиза):

```
Неделя 24.11 - 30.11:
Таверна - Пилигримы
«Герои русского инди» (ВКонтакте) (позиция 10)
«Рок потяжелее» (Яндекс Музыка) (Плейлист подборка)
```

Если релиз ещё не вышел, бот сообщит дату первой проверки и добавит UPC в очередь. Релизы без совпадений после проверки на дату релиза + 7 дней удаляются из очереди автоматически.

## Веб-интерфейс
Веб-приложение использует те же правила очереди и проверок, но позволяет работать через браузер:

- Страница `Добавить UPC` (http://localhost:8000/static/index.html) принимает список кодов, запускает проверку и сразу показывает найденные плейлисты или заметки, если релиз ещё не вышел.
- Страница `Релизы` (http://localhost:8000/static/releases.html) отображает все найденные попадания, сгруппированные по неделям (неделя = дата старта продаж + 7 дней, если это не уходит в будущее) и разбитые по месяцам.

Запуск сервера:

```bash
export ACCOUNT_USERNAME=...
export ACCOUNT_PASSWORD=...
uvicorn web:app --reload --host 0.0.0.0 --port 8000
```

Опциональные переменные окружения повторяют бот:

- `TOKEN_CACHE` — путь для кеша токенов (по умолчанию `token_cache.json`)
- `UPC_DB` — путь до SQLite базы с очередью и найденными релизами (по умолчанию `upc_checks.db`)
